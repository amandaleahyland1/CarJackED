<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CarJackEd – Synthwave DMV Challenge</title>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #05070b;
      --panel: #0b0f18;
      --neon: #00ff9c;
      --cyan: #2dd4ff;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top, #0d1325, var(--bg) 60%);
      font-family: Inter, system-ui, sans-serif;
      color: var(--text);
      overflow: hidden;
    }

    .hidden {
      display: none !important;
    }

    /* Landing map */
    #landing {
      position: relative;
      width: 100vw;
      height: 100vh;
    }

    #hud {
      position: fixed;
      top: 0;
      width: 100%;
      padding: 12px 18px;
      background: linear-gradient(to bottom, rgba(5,7,11,.9), rgba(5,7,11,.4));
      z-index: 50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #title {
      font-family: Oswald, sans-serif;
      font-size: 26px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #stats {
      font-size: 13px;
      color: var(--muted);
    }

    #stats span {
      color: var(--neon);
      margin-left: 6px;
    }

    #world {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }

    .zone {
      position: relative;
      border: 1px solid rgba(255,255,255,.04);
      padding: 20px;
      background-size: cover;
      background-position: center;
      transition: filter .3s;
      background: linear-gradient(135deg, rgba(45, 212, 255, 0.05), rgba(0, 255, 156, 0.08));
    }

    .zone.locked {
      filter: grayscale(1) brightness(.4);
    }

    .zone-title {
      font-family: Oswald, sans-serif;
      font-size: 18px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .zone-desc {
      font-size: 13px;
      color: var(--muted);
      max-width: 260px;
      line-height: 1.4;
    }

    .zone button {
      margin-top: 12px;
      padding: 8px 14px;
      background: none;
      border: 1px solid var(--neon);
      color: var(--neon);
      font-family: Oswald, sans-serif;
      cursor: pointer;
      text-transform: uppercase;
    }

    .zone button:hover {
      background: var(--neon);
      color: #000;
    }

    #modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    #modalContent {
      background: var(--panel);
      padding: 24px;
      width: 90%;
      max-width: 520px;
      border: 1px solid rgba(255,255,255,.08);
    }

    #modal h2 {
      font-family: Oswald, sans-serif;
      margin-top: 0;
    }

    #modal p {
      font-size: 14px;
      color: var(--muted);
    }

    #modal button {
      margin-top: 16px;
      padding: 8px 14px;
      background: var(--neon);
      border: none;
      font-family: Oswald, sans-serif;
      cursor: pointer;
    }

    #finalGate {
      position: absolute;
      inset: 0;
      display: none;
      background: radial-gradient(circle, #02120c, #000);
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 200;
    }

    #finalGate h1 {
      font-family: Oswald, sans-serif;
      font-size: 48px;
      letter-spacing: 2px;
    }

    #finalGate button {
      margin-top: 20px;
      padding: 12px 26px;
      font-family: Oswald, sans-serif;
      font-size: 18px;
      background: var(--neon);
      border: none;
      cursor: pointer;
    }

    /* Simulator */
    #simulator {
      position: absolute;
      inset: 0;
      display: none;
    }

    #simulator.active {
      display: flex;
    }

    #game-root {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
    }

    #game-canvas {
      flex: 1;
      background: linear-gradient(
        180deg,
        #ffb347 0%,
        #ff8c42 15%,
        #ff6b9d 30%,
        #c44569 50%,
        #2a1a4e 80%,
        #0a0014 100%
      );
      position: relative;
      cursor: none;
    }

    #hud-panel {
      width: 30%;
      height: 100%;
      background: linear-gradient(
        90deg,
        rgba(5, 6, 7, 0.98) 0%,
        rgba(10, 20, 40, 0.95) 100%
      );
      border-right: 3px solid #ffd45a;
      padding: 20px 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      pointer-events: auto;
    }

    #hud-panel::-webkit-scrollbar { width: 6px; }
    #hud-panel::-webkit-scrollbar-track { background: rgba(255, 212, 90, 0.1); }
    #hud-panel::-webkit-scrollbar-thumb { background: #ffd45a; border-radius: 3px; }

    #hud-title {
      font-family: "Georgia", serif;
      font-size: 24px;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 4px;
      color: #ffd45a;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      border-bottom: 2px solid rgba(255, 212, 90, 0.3);
      padding-bottom: 8px;
    }

    #hud-version {
      font-size: 10px;
      color: #888;
      margin-bottom: 16px;
      letter-spacing: 1px;
    }

    #hud-level-name { font-size: 18px; color: #ffd45a; margin-bottom: 4px; font-weight: bold; }
    #hud-location { font-size: 12px; color: #b0b0b0; margin-bottom: 12px; line-height: 1.3; }

    #hud-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #a0a0a0;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 212, 90, 0.15);
    }

    .hud-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #7fff8b;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    #hud-rules, #hud-hazards {
      font-size: 11px;
      line-height: 1.5;
      list-style: none;
      margin-bottom: 8px;
    }

    #hud-rules li, #hud-hazards li {
      padding-left: 14px;
      margin-bottom: 3px;
      position: relative;
      color: #d0d0d0;
    }

    #hud-rules li::before { content: "→"; position: absolute; left: 0; color: #ffd45a; }
    #hud-hazards li::before { content: "⚠"; position: absolute; left: 0; color: #ff6b9d; }

    #hud-objective {
      font-size: 11px;
      background: rgba(255, 212, 90, 0.08);
      border-left: 2px solid #ffd45a;
      padding: 8px 10px;
      margin-top: 12px;
      line-height: 1.4;
    }

    #hud-score-box {
      background: rgba(42, 26, 78, 0.6);
      border: 1px solid rgba(255, 212, 90, 0.2);
      padding: 10px;
      margin-top: 16px;
      font-size: 11px;
    }

    .score-row { display: flex; justify-content: space-between; margin-bottom: 4px; color: #a0a0a0; }
    .score-value { color: #ffd45a; font-weight: bold; }

    #hud-footer {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 212, 90, 0.15);
      font-size: 10px;
      color: #888;
      line-height: 1.6;
    }

    .key { background: rgba(0, 0, 0, 0.5); padding: 1px 4px; border-radius: 2px; color: #7fff8b; font-family: monospace; }

    .modal {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }

    .modal.active { display: flex; }

    .modal-content {
      background: linear-gradient(135deg, rgba(10, 20, 40, 0.98), rgba(42, 26, 78, 0.98));
      border: 2px solid #ffd45a;
      padding: 32px 40px;
      border-radius: 8px;
      text-align: center;
      max-width: 600px;
      box-shadow: 0 0 40px rgba(255, 212, 90, 0.3);
    }

    .modal-title {
      font-family: "Georgia", serif;
      font-size: 32px;
      letter-spacing: 2px;
      color: #ffd45a;
      margin-bottom: 16px;
      text-transform: uppercase;
    }

    .modal-text { font-size: 16px; color: #d0d0d0; margin-bottom: 24px; line-height: 1.6; }

    .modal-button {
      background: #ffd45a;
      color: #050607;
      border: none;
      padding: 12px 32px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }

    .modal-button:hover { background: #ffe98a; box-shadow: 0 0 12px rgba(255, 212, 90, 0.5); }

    #canvas-hud {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 212, 90, 0.3);
      padding: 12px 16px;
      font-size: 12px;
      border-radius: 4px;
      font-family: monospace;
    }

    .hud-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 4px; color: #a0a0a0; }
    .hud-label-small { color: #7fff8b; }
    .hud-value { color: #ffd45a; font-weight: bold; }

    #game-title {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-family: "Georgia", serif;
      font-size: 28px;
      letter-spacing: 3px;
      color: #ffd45a;
      text-shadow: 0 0 20px rgba(255, 212, 90, 0.5);
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="landing">
    <div id="hud">
      <div id="title">CarJackEd</div>
      <div id="stats">XP <span id="xp">0</span> · Car <span id="car">Beater Prelude</span></div>
    </div>

    <div id="world">
      <div class="zone" data-zone="0">
        <div class="zone-title">Beach Flats</div>
        <div class="zone-desc">Night driving fundamentals. Signs, signals, pedestrians, bike lanes.</div>
        <button onclick="completeZone(0)">Run Mission</button>
      </div>
      <div class="zone locked" data-zone="1">
        <div class="zone-title">Boardwalk</div>
        <div class="zone-desc">Right-of-way chaos, crosswalk discipline, traffic flow.</div>
        <button onclick="completeZone(1)">Run Mission</button>
      </div>
      <div class="zone locked" data-zone="2">
        <div class="zone-title">Pacific Ave</div>
        <div class="zone-desc">Speed law mastery. Lane control. Urban judgment.</div>
        <button onclick="completeZone(2)">Run Mission</button>
      </div>
      <div class="zone locked" data-zone="3">
        <div class="zone-title">Aptos Coast</div>
        <div class="zone-desc">Hills, curves, visibility, defensive driving.</div>
        <button onclick="completeZone(3)">Run Mission</button>
      </div>
      <div class="zone locked" data-zone="4">
        <div class="zone-title">Watsonville</div>
        <div class="zone-desc">Agricultural roads, large vehicles, real-world hazard awareness.</div>
        <button onclick="completeZone(4)">Run Mission</button>
      </div>
      <div class="zone locked" data-zone="5">
        <div class="zone-title">THE TEST</div>
        <div class="zone-desc">The final written exam. One destination. Unlimited retries.</div>
        <button onclick="launchFinal()">Enter</button>
      </div>
    </div>

    <div id="modal">
      <div id="modalContent">
        <h2>Mission Complete</h2>
        <p>You navigated the streets correctly and earned an upgrade.</p>
        <button onclick="closeModal()">Continue</button>
      </div>
    </div>

    <div id="finalGate">
      <div>
        <h1>THE TEST</h1>
        <p>Everything you learned leads here.</p>
        <button onclick="enterSimulator()">Start Driving Test</button>
        <div style="margin-top:12px;">
          <button onclick="restart()" style="font-size:14px; padding:10px 18px;">Restart Progress</button>
        </div>
      </div>
    </div>
  </div>

  <div id="simulator" class="hidden">
    <div id="game-root">
      <canvas id="game-canvas"></canvas>
      <div id="game-title">CARJACKED</div>
      <div id="canvas-hud">
        <div class="hud-row">
          <span class="hud-label-small">SPEED:</span>
          <span class="hud-value" id="hud-speed">0 mph</span>
        </div>
        <div class="hud-row">
          <span class="hud-label-small">LEVEL:</span>
          <span class="hud-value" id="hud-level-num">1/7</span>
        </div>
        <div class="hud-row">
          <span class="hud-label-small">STATUS:</span>
          <span class="hud-value" id="hud-status">DRIVING</span>
        </div>
      </div>

      <div id="hud-panel">
        <div id="hud-title">CarJacked</div>
        <div id="hud-version">DMV TEST MODE</div>

        <div id="hud-level-name"></div>
        <div id="hud-location"></div>

        <div id="hud-meta">
          <span id="hud-speed-limit"></span>
          <span id="hud-difficulty"></span>
        </div>

        <div class="hud-label">Critical Rules</div>
        <ul id="hud-rules"></ul>

        <div class="hud-label">Hazards</div>
        <ul id="hud-hazards"></ul>

        <div id="hud-objective"></div>

        <div id="hud-score-box">
          <div class="score-row">
            <span>Points:</span>
            <span class="score-value" id="score-display">0</span>
          </div>
          <div class="score-row">
            <span>Level:</span>
            <span class="score-value" id="level-display">1</span>
          </div>
          <div class="score-row">
            <span>Auto-fails:</span>
            <span class="score-value" id="fail-display">0</span>
          </div>
        </div>

        <div id="hud-footer">
          <div><span class="key">← ↑ ↓ →</span> or <span class="key">WASD</span> to drive</div>
          <div><span class="key">N</span> next level · <span class="key">P</span> pause</div>
          <div style="margin-top: 8px; color: #ff6b9d;">⚠ NO RIGHT TURN ON RED @ 41st/Brommer</div>
        </div>
      </div>
    </div>

    <div id="fail-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">CARJACKED</div>
        <div class="modal-text" id="fail-message"></div>
        <button class="modal-button" onclick="retryLevel()">RETRY</button>
        <button class="modal-button" onclick="skipLevel()">SKIP</button>
      </div>
    </div>

    <div id="complete-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">LEVEL CLEAR</div>
        <div class="modal-text" id="complete-message"></div>
        <button class="modal-button" onclick="nextLevel()">CONTINUE</button>
      </div>
    </div>

    <div id="gameover-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">TEST COMPLETE</div>
        <div class="modal-text" id="gameover-message"></div>
        <button class="modal-button" onclick="startGame()">START OVER</button>
      </div>
    </div>

    <div id="pause-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">PAUSED</div>
        <div class="modal-text">Press P to resume</div>
        <button class="modal-button" onclick="togglePause()">RESUME</button>
      </div>
    </div>
  </div>

  <script>
// ============================================================================
// CARJACKED - DMV Driving Test Simulator
// ============================================================================

const gameData = {
  game: {
    title: "CarJackED",
    startPoint: "6556 Freedom Boulevard, Aptos, CA",
    totalDistance: "15-18 miles",
    estimatedTime: "20-25 minutes",
    passingScore: 70,
    autoFailPoints: [
      "Running red light or stop sign",
      "No right turn on red at 41st/Brommer (CRITICAL)",
      "Hitting curb",
      "Unsafe lane changes",
      "Failing to yield to pedestrians",
      "Examiner intervention required",
      "Close call with pedestrian",
      "Stopping on railroad tracks",
      "Improper merge forcing traffic",
      "Extreme speeding",
      "Going under lowered railroad gate"
    ]
  },
  levels: [
    {
      id: 1,
      name: "Freedom Boulevard Approach",
      location: "6556 Freedom Blvd - Green Valley Road",
      distance: "2-3 miles",
      durationMinutes: 4,
      speedLimit: "40-45 mph",
      difficulty: "Easy",
      criticalRules: [
        "Maintain consistent speed",
        "Check mirrors every 5-8 seconds",
        "Keep 3-second following distance",
        "Signal 100+ feet before turning",
        "Stay centered in lane"
      ],
      hazards: [
        "School buses",
        "Pedestrians and cyclists",
        "Traffic density increases"
      ],
      keyPoints: [
        "Establish good mirror-checking habit early",
        "Demonstrate confident speed management",
        "Show smooth lane control"
      ]
    },
    {
      id: 2,
      name: "Green Valley Road & Main Street",
      location: "Green Valley Rd to Main St, Watsonville",
      distance: "1-2 miles",
      durationMinutes: 3,
      speedLimit: "25-35 mph",
      difficulty: "Easy-Medium",
      criticalRules: [
        "Complete stops at all stop signs",
        "Look both directions at every intersection",
        "Watch for sudden pedestrian crossings",
        "Watch for parked cars opening doors",
        "Lower residential speed limits"
      ],
      hazards: [
        "Residential traffic",
        "Stop signs (frequent)",
        "Pedestrians in neighborhoods",
        "Parked vehicles"
      ],
      keyPoints: [
        "Demonstrate full stop compliance",
        "Show pedestrian awareness",
        "Practice residential area safety"
      ]
    },
    {
      id: 3,
      name: "Valencia School Zone",
      location: "250 Aptos School Road, Aptos",
      distance: "1-2 miles",
      durationMinutes: 3,
      speedLimit: "25 mph (or posted lower)",
      difficulty: "Medium",
      criticalRules: [
        "Speed limit 25 mph within 500-1000 feet of school",
        "Speed limit enforced even without visible children",
        "Obey crossing guards completely",
        "Prepare to stop immediately",
        "Reduce speed gradually (not abruptly)"
      ],
      hazards: [
        "Children on bicycles/scooters",
        "Crossing guards",
        "School buses",
        "Sudden pedestrian crossings",
        "Low visibility areas"
      ],
      keyPoints: [
        "Demonstrate speed reduction technique",
        "Show crossing guard obedience",
        "Practice pedestrian alert driving"
      ]
    },
    {
      id: 4,
      name: "Railroad Crossing Protocol",
      location: "Active railroad crossing location",
      distance: "1-2 miles",
      durationMinutes: 2,
      speedLimit: "15 mph (uncontrolled crossings)",
      difficulty: "Medium",
      criticalRules: [
        "NEVER stop ON railroad tracks",
        "NEVER go under or around lowered gates",
        "Speed limit 15 mph within 100 feet",
        "Stop if lights are flashing",
        "Look both directions for trains"
      ],
      hazards: [
        "Flashing red lights",
        "Lowered crossing gates",
        "Train horns and bells",
        "Multiple tracks",
        "Silent trains (deadly)"
      ],
      keyPoints: [
        "Know automatic failure points",
        "Demonstrate hazard awareness",
        "Practice safe crossing procedure"
      ]
    },
    {
      id: 5,
      name: "Highway Merging & Passing Section",
      location: "Highway scenic section (Highway 1 or local equivalent)",
      distance: "3-4 miles",
      durationMinutes: 5,
      speedLimit: "55-65 mph",
      difficulty: "Hard",
      criticalRules: [
        "Signal early (5 seconds/100 feet)",
        "Check mirrors AND blind spots",
        "Match highway speed smoothly",
        "Find 4-second gap before merging",
        "No sudden jerks or last-minute changes"
      ],
      hazards: [
        "Fast-moving traffic",
        "Blind spots",
        "Multiple lanes",
        "Merging vehicles",
        "Lane changes required",
        "Passing situations"
      ],
      keyPoints: [
        "Master the 5-step merge process",
        "Demonstrate blind spot checking",
        "Practice smooth acceleration"
      ]
    },
    {
      id: 6,
      name: "Santa Cruz Boardwalk/Beach Complex Pedestrian Area",
      location: "Santa Cruz Boardwalk and beach parking areas",
      distance: "2-3 miles",
      durationMinutes: 5,
      speedLimit: "15-25 mph",
      difficulty: "Hard",
      criticalRules: [
        "Reduce speed significantly (15-25 mph)",
        "ALWAYS yield to pedestrians in crosswalks",
        "Stop completely - don't proceed if pedestrian near",
        "Watch for tourists not paying attention",
        "Smooth parallel parking (12 inches from curb)"
      ],
      hazards: [
        "High pedestrian traffic",
        "Tourists (unpredictable)",
        "Bicyclists and skateboarders",
        "One-way streets",
        "Angled parking",
        "Heavy traffic congestion",
        "Jaywalking pedestrians"
      ],
      keyPoints: [
        "Demonstrate pedestrian priority",
        "Show parallel parking skill",
        "Practice high-stress navigation"
      ]
    },
    {
      id: 7,
      name: "41st Avenue & Brommer Street - CRITICAL INTERSECTION",
      location: "41st Avenue (heading toward beach) to Brommer Street",
      distance: "Return route segment",
      durationMinutes: 2,
      speedLimit: "25-35 mph",
      difficulty: "EXTREME - AUTOMATIC FAIL POINT",
      criticalRules: [
        "⚠️ NO RIGHT TURN ON RED - POSTED SIGN",
        "Coming to complete stop at red light",
        "Wait for green arrow or green light",
        "Check for pedestrians in crosswalk before turning",
        "Signal turn smoothly",
        "This is the #1 automatic failure point on this test"
      ],
      hazards: [
        "Confusing traffic signal",
        "Pedestrian traffic",
        "Easy to make wrong assumption about right turn",
        "Most test-takers fail here"
      ],
      keyPoints: [
        "MEMORIZE this intersection rule",
        "Practice waiting for green before turning right",
        "Know this intersection cold before test day"
      ]
    }
  ]
};

// Canvas & DOM
const canvas = document.getElementById("game-canvas");
const ctx = canvas.getContext("2d");

const failModal = document.getElementById("fail-modal");
const completeModal = document.getElementById("complete-modal");
const gameoverModal = document.getElementById("gameover-modal");
const pauseModal = document.getElementById("pause-modal");

const hudLevelName = document.getElementById("hud-level-name");
const hudLocation = document.getElementById("hud-location");
const hudRules = document.getElementById("hud-rules");
const hudHazards = document.getElementById("hud-hazards");
const hudSpeedLimit = document.getElementById("hud-speed-limit");
const hudDifficulty = document.getElementById("hud-difficulty");
const hudSpeed = document.getElementById("hud-speed");
const hudLevelNum = document.getElementById("hud-level-num");
const scoreDisplay = document.getElementById("score-display");
const levelDisplay = document.getElementById("level-display");

// Game state
let state = {
  currentLevelIndex: 0,
  score: 0,
  autoFails: 0,
  isPaused: false,
  isComplete: false,
  keys: {},
  car: {
    x: 0,
    y: 0,
    w: 40,
    h: 70,
    speed: 0,
    angle: 0,
    maxSpeed: 8,
    accel: 0.15,
    friction: 0.05
  },
  levelStartTime: 0,
  frameCount: 0,
  violations: []
};

// Input
window.addEventListener("keydown", e => {
  const key = e.key.toLowerCase();
  state.keys[key] = true;
  if (key === "p") togglePause();
  if (key === "n" && !state.isComplete) nextLevel();
});

window.addEventListener("keyup", e => {
  state.keys[e.key.toLowerCase()] = false;
});

// Init
function initializeGame() {
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);
  startGame();
}

function resizeCanvas() {
  canvas.width = window.innerWidth * 0.7;
  canvas.height = window.innerHeight;
}

function startGame() {
  state.currentLevelIndex = 0;
  state.score = 0;
  state.autoFails = 0;
  state.isComplete = false;
  closeAllModals();
  startLevel(0);
  gameLoop();
}

function startLevel(index) {
  state.currentLevelIndex = Math.min(index, gameData.levels.length - 1);
  state.levelStartTime = Date.now();
  state.frameCount = 0;
  state.violations = [];

  const level = gameData.levels[state.currentLevelIndex];

  state.car.x = canvas.width * 0.5;
  state.car.y = canvas.height * 0.6;
  state.car.speed = 0;
  state.car.angle = -Math.PI / 2;

  updateHUD(level);
}

function updateHUD(level) {
  hudLevelName.textContent = level.name;
  hudLocation.textContent = level.location;
  hudSpeedLimit.textContent = level.speedLimit;
  hudDifficulty.textContent = level.difficulty;

  hudRules.innerHTML = "";
  level.criticalRules.slice(0, 5).forEach(rule => {
    const li = document.createElement("li");
    li.textContent = rule;
    hudRules.appendChild(li);
  });

  hudHazards.innerHTML = "";
  level.hazards.slice(0, 5).forEach(h => {
    const li = document.createElement("li");
    li.textContent = h;
    hudHazards.appendChild(li);
  });

  hudLevelNum.textContent = `${state.currentLevelIndex + 1}/${gameData.levels.length}`;
  levelDisplay.textContent = state.currentLevelIndex + 1;
  scoreDisplay.textContent = state.score;
}

function nextLevel() {
  if (state.currentLevelIndex < gameData.levels.length - 1) {
    state.currentLevelIndex++;
    startLevel(state.currentLevelIndex);
    closeAllModals();
  } else {
    completeGame();
  }
}

function skipLevel() {
  state.autoFails++;
  document.getElementById("fail-display").textContent = state.autoFails;
  nextLevel();
}

function retryLevel() {
  startLevel(state.currentLevelIndex);
  closeAllModals();
}

function completeGame() {
  state.isComplete = true;
  const gameoverMessage = document.getElementById("gameover-message");
  const finalScore = state.score - state.autoFails * 30;
  const passed = finalScore >= gameData.game.passingScore;
  gameoverMessage.innerHTML = `
    <strong>${passed ? "PASSED!" : "FAILED"}</strong><br>
    Final Score: ${Math.max(0, finalScore)}<br>
    Auto-Fails: ${state.autoFails}<br>
    ${passed ? "You are ready for the real test!" : "Review the rules and try again."}
  `;
  gameoverModal.classList.add("active");
}

function togglePause() {
  state.isPaused = !state.isPaused;
  if (state.isPaused) {
    pauseModal.classList.add("active");
  } else {
    pauseModal.classList.remove("active");
  }
}

function closeAllModals() {
  failModal.classList.remove("active");
  completeModal.classList.remove("active");
  gameoverModal.classList.remove("active");
  pauseModal.classList.remove("active");
}

function triggerAutoFail(reason) {
  state.autoFails++;
  document.getElementById("fail-display").textContent = state.autoFails;
  const failMessage = document.getElementById("fail-message");
  failMessage.innerHTML = `<strong>AUTO-FAIL</strong><br>${reason}`;
  failModal.classList.add("active");
}

// Game loop
function update() {
  if (state.isPaused || state.isComplete) return;

  const { keys, car } = state;

  if (keys["arrowup"] || keys["w"]) car.speed += car.accel;
  if (keys["arrowdown"] || keys["s"]) car.speed -= car.accel;

  car.speed = Math.max(-car.maxSpeed * 0.5, Math.min(car.maxSpeed, car.speed));

  if (Math.abs(car.speed) > 0.1) {
    if (keys["arrowleft"] || keys["a"]) car.angle -= 0.04 * Math.sign(car.speed);
    if (keys["arrowright"] || keys["d"]) car.angle += 0.04 * Math.sign(car.speed);
  }

  if (car.speed > 0) car.speed -= car.friction;
  else if (car.speed < 0) car.speed += car.friction;
  if (Math.abs(car.speed) < 0.02) car.speed = 0;

  car.x += Math.cos(car.angle) * car.speed;
  car.y += Math.sin(car.angle) * car.speed;

  const margin = 40;
  car.x = Math.max(margin, Math.min(canvas.width - margin, car.x));
  car.y = Math.max(margin, Math.min(canvas.height - margin, car.y));

  checkViolations();

  const displaySpeed = Math.abs(Math.round(car.speed * 10));
  hudSpeed.textContent = `${displaySpeed} mph`;

  state.frameCount++;

  const levelDuration = gameData.levels[state.currentLevelIndex].durationMinutes * 1000;
  if (Date.now() - state.levelStartTime > levelDuration + 2000 && state.frameCount > 60) {
    state.score += 100 - state.violations.length * 5;
    const completeMessage = document.getElementById("complete-message");
    completeMessage.innerHTML = `Level ${state.currentLevelIndex + 1} Complete<br>Score: +${100 - state.violations.length * 5}`;
    completeModal.classList.add("active");
  }
}

function checkViolations() {
  const level = gameData.levels[state.currentLevelIndex];
  const { car } = state;

  // Level 7: 41st & Brommer
  if (state.currentLevelIndex === 6) {
    const intersectionX = canvas.width * 0.5;
    const intersectionY = canvas.height * 0.3;
    const distToIntersection = Math.hypot(car.x - intersectionX, car.y - intersectionY);

    if (distToIntersection < 100) {
      const lightCycle = Math.floor((state.frameCount / 180) % 2);
      const isRedLight = lightCycle === 0;

      if (isRedLight && Math.abs(car.angle) < 0.5 && car.speed > 0) {
        if (!state.violations.includes("right_on_red_41st")) {
          state.violations.push("right_on_red_41st");
          triggerAutoFail("❌ NO RIGHT TURN ON RED @ 41st & Brommer\nAUTOMATIC TEST FAILURE!");
        }
      }
    }
  }

  const speedLimitStr = level.speedLimit.split("-")[0];
  const speedLimit = parseInt(speedLimitStr) || 55;
  const carSpeed = Math.abs(state.car.speed * 10);

  if (carSpeed > speedLimit * 1.2 && !state.violations.includes("speeding")) {
    state.violations.push("speeding");
  }
}

function render() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const roadWidth = canvas.width * 0.35;
  const roadX = canvas.width * 0.5 - roadWidth / 2;

  ctx.fillStyle = "#222233";
  ctx.fillRect(roadX, 0, roadWidth, canvas.height);

  ctx.strokeStyle = "#ffd45a";
  ctx.lineWidth = 3;
  ctx.setLineDash([40, 20]);
  ctx.beginPath();
  ctx.moveTo(canvas.width * 0.5, 0);
  ctx.lineTo(canvas.width * 0.5, canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);

  ctx.strokeStyle = "#ffd45aaa";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(roadX, 0);
  ctx.lineTo(roadX, canvas.height);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(roadX + roadWidth, 0);
  ctx.lineTo(roadX + roadWidth, canvas.height);
  ctx.stroke();

  const sunY = canvas.height * 0.2;
  const sunR = canvas.height * 0.15;
  const sunX = canvas.width * 0.5;
  const grd = ctx.createRadialGradient(sunX, sunY, sunR * 0.2, sunX, sunY, sunR);
  grd.addColorStop(0, "#ffe98acc");
  grd.addColorStop(0.5, "#ff8a4acc");
  grd.addColorStop(1, "rgba(0,0,0,0)");
  ctx.fillStyle = grd;
  ctx.beginPath();
  ctx.arc(sunX, sunY, sunR, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#260043dd";
  ctx.beginPath();
  ctx.moveTo(0, sunY + sunR * 0.5);
  ctx.lineTo(canvas.width * 0.3, sunY - 60);
  ctx.lineTo(canvas.width * 0.6, sunY + 20);
  ctx.lineTo(canvas.width, sunY + sunR * 0.4);
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.closePath();
  ctx.fill();

  drawCar(state.car);

  if (state.currentLevelIndex === 6) {
    drawIntersection();
  }

  drawHazards();
}

function drawCar(car) {
  ctx.save();
  ctx.translate(car.x, car.y);
  ctx.rotate(car.angle);

  ctx.fillStyle = "#ff7b2c";
  ctx.strokeStyle = "#ffd45a";
  ctx.lineWidth = 2;
  ctx.fillRect(-car.w / 2, -car.h / 2, car.w, car.h);
  ctx.strokeRect(-car.w / 2, -car.h / 2, car.w, car.h);

  ctx.fillStyle = "#0a1622dd";
  ctx.fillRect(-car.w / 2 + 4, -car.h / 2 + 8, car.w - 8, 20);

  ctx.fillStyle = "#0a1622aa";
  ctx.fillRect(-car.w / 2 + 6, -car.h / 2 + 28, car.w - 12, 14);

  ctx.fillStyle = "#111";
  const wheelW = 8;
  const wheelH = 16;
  ctx.fillRect(-car.w / 2 - 4, -car.h / 2 + 5, wheelW, wheelH);
  ctx.fillRect(-car.w / 2 - 4, car.h / 2 - 21, wheelW, wheelH);
  ctx.fillRect(car.w / 2 - 4, -car.h / 2 + 5, wheelW, wheelH);
  ctx.fillRect(car.w / 2 - 4, car.h / 2 - 21, wheelW, wheelH);

  ctx.fillStyle = "#ffeb3b";
  ctx.beginPath();
  ctx.arc(-car.w / 2 + 4, -car.h / 2, 2, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.arc(car.w / 2 - 4, -car.h / 2, 2, 0, Math.PI * 2);
  ctx.fill();

  ctx.restore();
}

function drawIntersection() {
  const intersectionX = canvas.width * 0.5;
  const intersectionY = canvas.height * 0.3;

  ctx.fillStyle = "rgba(255, 100, 100, 0.3)";
  ctx.beginPath();
  ctx.arc(intersectionX, intersectionY, 80, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#333";
  ctx.fillRect(intersectionX + 70, intersectionY - 30, 20, 80);

  const lightCycle = Math.floor((state.frameCount / 180) % 2);
  ctx.fillStyle = lightCycle === 0 ? "#ff4444" : "#44ff44";
  ctx.beginPath();
  ctx.arc(intersectionX + 80, intersectionY - 10, 8, 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#ff6b9d";
  ctx.font = "bold 14px Arial";
  ctx.fillText("NO RIGHT", intersectionX - 40, intersectionY - 60);
  ctx.fillText("ON RED", intersectionX - 35, intersectionY - 44);
}

function drawHazards() {
  const level = gameData.levels[state.currentLevelIndex];
  const pedestrianCount = level.id === 6 ? 4 : 1;

  for (let i = 0; i < pedestrianCount; i++) {
    const x = canvas.width * 0.35 + i * 40;
    const y = canvas.height * 0.5 + Math.sin(state.frameCount * 0.02 + i) * 20;

    ctx.fillStyle = "rgba(255, 107, 157, 0.6)";
    ctx.beginPath();
    ctx.arc(x, y, 8, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#ff6b9d";
    ctx.font = "bold 10px Arial";
    ctx.textAlign = "center";
    ctx.fillText("P", x, y + 3);
  }
}

function gameLoop() {
  update();
  render();
  requestAnimationFrame(gameLoop);
}

window.addEventListener("load", initializeGame);
  </script>
  <script>
    const zones = document.querySelectorAll("#world .zone");
    const xpDisplay = document.getElementById("xp");
    const carDisplay = document.getElementById("car");
    const landingModal = document.getElementById("modal");
    const landingModalBody = landingModal.querySelector("p");
    const finalGate = document.getElementById("finalGate");
    const simulator = document.getElementById("simulator");
    const landing = document.getElementById("landing");

    let xp = 0;
    let carIndex = 0;
    const cars = [
      "Beater Prelude",
      "Civic Si",
      "WRX",
      "BMW 340i",
      "370Z",
      "Audi RS3",
      "Lifted Black Truck",
      "Challenger (Black + Green)",
      "Hypercar"
    ];

    function completeZone(index) {
      xp += 250;
      xpDisplay.innerText = xp;

      if (carIndex < cars.length - 1) {
        carIndex++;
        carDisplay.innerText = cars[carIndex];
      }

      const level = gameData.levels[index];
      if (level) {
        landingModalBody.innerText = `${level.name}: ${level.keyPoints ? level.keyPoints[0] : "Smooth driving keeps you moving."}`;
      }

      if (zones[index + 1]) {
        zones[index + 1].classList.remove("locked");
      }

      landingModal.style.display = "flex";
    }

    function closeModal() {
      landingModal.style.display = "none";
    }

    function launchFinal() {
      finalGate.style.display = "flex";
    }

    function enterSimulator() {
      finalGate.style.display = "none";
      landing.classList.add("hidden");
      simulator.classList.add("active");
      simulator.classList.remove("hidden");
    }

    function restart() {
      location.reload();
    }

    function hydrateLanding() {
      zones.forEach(zone => {
        const idx = Number(zone.getAttribute("data-zone"));
        const level = gameData.levels[idx];
        if (level) {
          const titleEl = zone.querySelector(".zone-title");
          const descEl = zone.querySelector(".zone-desc");
          if (titleEl) titleEl.textContent = level.name;
          if (descEl) descEl.textContent = level.location;
        }
      });
    }

    window.addEventListener("load", hydrateLanding);
  </script>
</body>
</html>
